import { unzoomImage, getScale, sumValues } from './utils/helpers';
import { Inject, Injectable } from '@angular/core';
import { DOCUMENT } from '@angular/common';
import { css } from './styles';
import { debounce } from './utils/debounce';
import * as i0 from "@angular/core";
export class NgZoom {
    constructor(document) {
        this.document = document;
        this.defaultConfig = {
            padding: 20,
            exceed: false,
        };
        this.zoomed = null;
        this.handleClick = debounce((image) => {
            if (this.zoomed) {
                unzoomImage(this.zoomed);
                this.zoomed = null;
                return;
            }
            if (image) {
                this.zoomImage(image, this.defaultConfig);
                this.zoomed = image;
            }
        }, 500, {
            isImmediate: true,
        });
        this.handleUnzoomingInteraction = () => {
            if (!this.zoomed)
                return;
            unzoomImage(this.zoomed);
            this.zoomed = null;
        };
        this.handleKeydown = (e) => {
            if (e.code != 'Escape')
                return;
            e.preventDefault();
            if (this.zoomed) {
                unzoomImage(this.zoomed);
                this.zoomed = null;
            }
        };
        this.injectStyles = () => {
            const styles = this.document.createElement('style');
            styles.innerHTML = css;
            this.document.head.appendChild(styles);
        };
        this.zoomImage = (image, config) => {
            const imageRect = image.getBoundingClientRect();
            const imageStyle = this.window.getComputedStyle(image);
            const imageWidth = imageRect.width -
                sumValues(imageStyle, [
                    'borderLeftWidth',
                    'borderRightWidth',
                    'paddingLeft',
                    'paddingRight',
                ]);
            const imageHeight = imageRect.height -
                sumValues(imageStyle, [
                    'borderTopWidth',
                    'borderBottomWidth',
                    'paddingTop',
                    'paddingBottom',
                ]);
            const vw = this.window.innerWidth;
            const vh = this.window.innerHeight;
            const shouldExceed = config.exceed || image.dataset?.['imageZoomExceed'] == 'true';
            let scale = getScale(imageHeight, imageWidth, vh, vw);
            if (!shouldExceed) {
                const limitedScale = getScale(imageHeight, imageWidth, image.naturalHeight, image.naturalWidth);
                scale = Math.min(scale, limitedScale);
            }
            const isPaddingNeeded = config.padding >
                Math.min(vh - imageHeight * scale, vw - imageWidth * scale) / 2;
            if (isPaddingNeeded) {
                let scaleWithPaddingBeforeExceed = getScale(imageHeight + config.padding, imageWidth + config.padding, vh, vw);
                if (!shouldExceed) {
                    const limitedScale = getScale(imageHeight, imageWidth, image.naturalHeight - config.padding, image.naturalWidth - config.padding);
                    scaleWithPaddingBeforeExceed = Math.min(scaleWithPaddingBeforeExceed, limitedScale);
                }
                scale = scaleWithPaddingBeforeExceed;
            }
            const doc = this.document.documentElement;
            const scrollLeft = (this.window.pageXOffset || doc.scrollLeft) - (doc.clientLeft || 0);
            const scrollTop = (this.window.pageYOffset || doc.scrollTop) - (doc.clientTop || 0);
            const imageCenterX = scrollLeft + imageRect.left + imageRect.width / 2;
            const imageCenterY = scrollTop + imageRect.top + imageRect.height / 2;
            const screenCenterX = scrollLeft + vw / 2;
            const screenCenterY = scrollTop + vh / 2;
            const translateX = (screenCenterX - imageCenterX) / scale;
            const translateY = (screenCenterY - imageCenterY) / scale;
            image.classList.add('image-zoom-zoomed');
            image.parentElement?.classList.add('image-zoom-wrapper-zoomed');
            image.style.transform = `scale(${scale}) translate(${translateX}px, ${translateY}px)`;
        };
        this.processImage = (image) => {
            // create an image wrapper element
            const wrapper = this.document.createElement('div');
            // let wrapper mimick pearl display property to not break anything
            wrapper.classList.add('image-zoom-wrapper');
            wrapper.style.display = this.window.getComputedStyle(image).display;
            image.parentElement?.insertBefore(wrapper, image);
            wrapper.appendChild(image);
            image.classList.add('image-zoom');
            image.style.transform = 'scale(1)';
        };
        this.window = this.document.defaultView;
        this.injectStyles();
        this.document.body.addEventListener('click', () => {
            this.handleClick(null);
        });
        this.document.addEventListener('keydown', this.handleKeydown);
        this.window.addEventListener('scroll', this.handleUnzoomingInteraction);
        this.window.addEventListener('resize', this.handleUnzoomingInteraction);
    }
    listen(imageRef) {
        const image = imageRef.nativeElement;
        this.processImage(image);
        image.addEventListener('click', () => {
            this.handleClick(image);
        });
    }
}
NgZoom.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.0.3", ngImport: i0, type: NgZoom, deps: [{ token: DOCUMENT }], target: i0.ɵɵFactoryTarget.Injectable });
NgZoom.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "13.0.3", ngImport: i0, type: NgZoom, providedIn: 'root' });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.0.3", ngImport: i0, type: NgZoom, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root',
                }]
        }], ctorParameters: function () { return [{ type: Document, decorators: [{
                    type: Inject,
                    args: [DOCUMENT]
                }] }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmctem9vbS5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vcHJvamVjdHMvbmctem9vbS9zcmMvbGliL25nLXpvb20uc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEVBQUUsV0FBVyxFQUFFLFFBQVEsRUFBRSxTQUFTLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUNuRSxPQUFPLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBYyxNQUFNLGVBQWUsQ0FBQztBQUMvRCxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDM0MsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUMvQixPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sa0JBQWtCLENBQUM7O0FBSzVDLE1BQU0sT0FBTyxNQUFNO0lBRWpCLFlBQXNDLFFBQWtCO1FBQWxCLGFBQVEsR0FBUixRQUFRLENBQVU7UUFvQmhELGtCQUFhLEdBQVc7WUFDOUIsT0FBTyxFQUFFLEVBQUU7WUFDWCxNQUFNLEVBQUUsS0FBSztTQUNkLENBQUM7UUFFTSxXQUFNLEdBQTRCLElBQUksQ0FBQztRQUV2QyxnQkFBVyxHQUFHLFFBQVEsQ0FDNUIsQ0FBQyxLQUE4QixFQUFFLEVBQUU7WUFDakMsSUFBSSxJQUFJLENBQUMsTUFBTSxFQUFFO2dCQUNmLFdBQVcsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7Z0JBQ3pCLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDO2dCQUNuQixPQUFPO2FBQ1I7WUFFRCxJQUFJLEtBQUssRUFBRTtnQkFDVCxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUM7Z0JBQzFDLElBQUksQ0FBQyxNQUFNLEdBQUcsS0FBSyxDQUFDO2FBQ3JCO1FBQ0gsQ0FBQyxFQUNELEdBQUcsRUFDSDtZQUNFLFdBQVcsRUFBRSxJQUFJO1NBQ2xC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Q2hELElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDekIsQ0FBQyxDQUFDLENBQUM7UUFDSCxJQUFJLENBQUMsUUFBUSxDQUFDLGdCQUFnQixDQUFDLFNBQVMsRUFBRSxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUM7UUFDOUQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLDBCQUEwQixDQUFDLENBQUM7UUFDeEUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLDBCQUEwQixDQUFDLENBQUM7SUFDMUUsQ0FBQztJQUVNLE1BQU0sQ0FBQyxRQUFzQztRQUNsRCxNQUFNLEtBQUssR0FBcUIsUUFBUSxDQUFDLGFBQWEsQ0FBQztRQUN2RCxJQUFJLENBQUMsWUFBWSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ3pCLEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPLEVBQUUsR0FBRyxFQUFFO1lBQ25DLElBQUksQ0FBQyxXQUFXLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDMUIsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDOzttR0FwQlUsTUFBTSxrQkFFRyxRQUFRO3VHQUZqQixNQUFNLGNBRkwsTUFBTTsyRkFFUCxNQUFNO2tCQUhsQixVQUFVO21CQUFDO29CQUNWLFVBQVUsRUFBRSxNQUFNO2lCQUNuQjswREFHaUQsUUFBUTswQkFBM0MsTUFBTTsyQkFBQyxRQUFRIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29uZmlnIH0gZnJvbSAnLi9tb2RlbHMvY29uZmlnJztcbmltcG9ydCB7IHVuem9vbUltYWdlLCBnZXRTY2FsZSwgc3VtVmFsdWVzIH0gZnJvbSAnLi91dGlscy9oZWxwZXJzJztcbmltcG9ydCB7IEluamVjdCwgSW5qZWN0YWJsZSwgRWxlbWVudFJlZiB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgRE9DVU1FTlQgfSBmcm9tICdAYW5ndWxhci9jb21tb24nO1xuaW1wb3J0IHsgY3NzIH0gZnJvbSAnLi9zdHlsZXMnO1xuaW1wb3J0IHsgZGVib3VuY2UgfSBmcm9tICcuL3V0aWxzL2RlYm91bmNlJztcblxuQEluamVjdGFibGUoe1xuICBwcm92aWRlZEluOiAncm9vdCcsXG59KVxuZXhwb3J0IGNsYXNzIE5nWm9vbSB7XG4gIHByaXZhdGUgd2luZG93OiBXaW5kb3c7XG4gIGNvbnN0cnVjdG9yKEBJbmplY3QoRE9DVU1FTlQpIHByaXZhdGUgZG9jdW1lbnQ6IERvY3VtZW50KSB7XG4gICAgdGhpcy53aW5kb3cgPSB0aGlzLmRvY3VtZW50LmRlZmF1bHRWaWV3IGFzIFdpbmRvdztcbiAgICB0aGlzLmluamVjdFN0eWxlcygpO1xuXG4gICAgdGhpcy5kb2N1bWVudC5ib2R5LmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCkgPT4ge1xuICAgICAgdGhpcy5oYW5kbGVDbGljayhudWxsKTtcbiAgICB9KTtcbiAgICB0aGlzLmRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2tleWRvd24nLCB0aGlzLmhhbmRsZUtleWRvd24pO1xuICAgIHRoaXMud2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3Njcm9sbCcsIHRoaXMuaGFuZGxlVW56b29taW5nSW50ZXJhY3Rpb24pO1xuICAgIHRoaXMud2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3Jlc2l6ZScsIHRoaXMuaGFuZGxlVW56b29taW5nSW50ZXJhY3Rpb24pO1xuICB9XG5cbiAgcHVibGljIGxpc3RlbihpbWFnZVJlZjogRWxlbWVudFJlZjxIVE1MSW1hZ2VFbGVtZW50Pik6IHZvaWQge1xuICAgIGNvbnN0IGltYWdlOiBIVE1MSW1hZ2VFbGVtZW50ID0gaW1hZ2VSZWYubmF0aXZlRWxlbWVudDtcbiAgICB0aGlzLnByb2Nlc3NJbWFnZShpbWFnZSk7XG4gICAgaW1hZ2UuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKSA9PiB7XG4gICAgICB0aGlzLmhhbmRsZUNsaWNrKGltYWdlKTtcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgZGVmYXVsdENvbmZpZzogQ29uZmlnID0ge1xuICAgIHBhZGRpbmc6IDIwLFxuICAgIGV4Y2VlZDogZmFsc2UsXG4gIH07XG5cbiAgcHJpdmF0ZSB6b29tZWQ6IEhUTUxJbWFnZUVsZW1lbnQgfCBudWxsID0gbnVsbDtcblxuICBwcml2YXRlIGhhbmRsZUNsaWNrID0gZGVib3VuY2UoXG4gICAgKGltYWdlOiBIVE1MSW1hZ2VFbGVtZW50IHwgbnVsbCkgPT4ge1xuICAgICAgaWYgKHRoaXMuem9vbWVkKSB7XG4gICAgICAgIHVuem9vbUltYWdlKHRoaXMuem9vbWVkKTtcbiAgICAgICAgdGhpcy56b29tZWQgPSBudWxsO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIGlmIChpbWFnZSkge1xuICAgICAgICB0aGlzLnpvb21JbWFnZShpbWFnZSwgdGhpcy5kZWZhdWx0Q29uZmlnKTtcbiAgICAgICAgdGhpcy56b29tZWQgPSBpbWFnZTtcbiAgICAgIH1cbiAgICB9LFxuICAgIDUwMCxcbiAgICB7XG4gICAgICBpc0ltbWVkaWF0ZTogdHJ1ZSxcbiAgICB9XG4gICk7XG5cbiAgcHJpdmF0ZSBoYW5kbGVVbnpvb21pbmdJbnRlcmFjdGlvbiA9ICgpOiB2b2lkID0+IHtcbiAgICBpZiAoIXRoaXMuem9vbWVkKSByZXR1cm47XG4gICAgdW56b29tSW1hZ2UodGhpcy56b29tZWQpO1xuICAgIHRoaXMuem9vbWVkID0gbnVsbDtcbiAgfTtcblxuICBwcml2YXRlIGhhbmRsZUtleWRvd24gPSAoZTogS2V5Ym9hcmRFdmVudCk6IHZvaWQgPT4ge1xuICAgIGlmIChlLmNvZGUgIT0gJ0VzY2FwZScpIHJldHVybjtcbiAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgaWYgKHRoaXMuem9vbWVkKSB7XG4gICAgICB1bnpvb21JbWFnZSh0aGlzLnpvb21lZCk7XG4gICAgICB0aGlzLnpvb21lZCA9IG51bGw7XG4gICAgfVxuICB9O1xuXG4gIHByaXZhdGUgaW5qZWN0U3R5bGVzID0gKCk6IHZvaWQgPT4ge1xuICAgIGNvbnN0IHN0eWxlczogSFRNTFN0eWxlRWxlbWVudCA9IHRoaXMuZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc3R5bGUnKTtcbiAgICBzdHlsZXMuaW5uZXJIVE1MID0gY3NzO1xuXG4gICAgdGhpcy5kb2N1bWVudC5oZWFkLmFwcGVuZENoaWxkKHN0eWxlcyk7XG4gIH07XG5cbiAgcHJpdmF0ZSB6b29tSW1hZ2UgPSAoaW1hZ2U6IEhUTUxJbWFnZUVsZW1lbnQsIGNvbmZpZzogQ29uZmlnKTogdm9pZCA9PiB7XG4gICAgY29uc3QgaW1hZ2VSZWN0OiBET01SZWN0ID0gaW1hZ2UuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XG4gICAgY29uc3QgaW1hZ2VTdHlsZTogQ1NTU3R5bGVEZWNsYXJhdGlvbiA9IHRoaXMud2luZG93LmdldENvbXB1dGVkU3R5bGUoaW1hZ2UpO1xuXG4gICAgY29uc3QgaW1hZ2VXaWR0aDogbnVtYmVyID1cbiAgICAgIGltYWdlUmVjdC53aWR0aCAtXG4gICAgICBzdW1WYWx1ZXMoaW1hZ2VTdHlsZSwgW1xuICAgICAgICAnYm9yZGVyTGVmdFdpZHRoJyxcbiAgICAgICAgJ2JvcmRlclJpZ2h0V2lkdGgnLFxuICAgICAgICAncGFkZGluZ0xlZnQnLFxuICAgICAgICAncGFkZGluZ1JpZ2h0JyxcbiAgICAgIF0pO1xuXG4gICAgY29uc3QgaW1hZ2VIZWlnaHQ6IG51bWJlciA9XG4gICAgICBpbWFnZVJlY3QuaGVpZ2h0IC1cbiAgICAgIHN1bVZhbHVlcyhpbWFnZVN0eWxlLCBbXG4gICAgICAgICdib3JkZXJUb3BXaWR0aCcsXG4gICAgICAgICdib3JkZXJCb3R0b21XaWR0aCcsXG4gICAgICAgICdwYWRkaW5nVG9wJyxcbiAgICAgICAgJ3BhZGRpbmdCb3R0b20nLFxuICAgICAgXSk7XG5cbiAgICBjb25zdCB2dzogbnVtYmVyID0gdGhpcy53aW5kb3cuaW5uZXJXaWR0aDtcbiAgICBjb25zdCB2aDogbnVtYmVyID0gdGhpcy53aW5kb3cuaW5uZXJIZWlnaHQ7XG5cbiAgICBjb25zdCBzaG91bGRFeGNlZWQ6IGJvb2xlYW4gPVxuICAgICAgY29uZmlnLmV4Y2VlZCB8fCBpbWFnZS5kYXRhc2V0Py5bJ2ltYWdlWm9vbUV4Y2VlZCddID09ICd0cnVlJztcbiAgICBsZXQgc2NhbGU6IG51bWJlciA9IGdldFNjYWxlKGltYWdlSGVpZ2h0LCBpbWFnZVdpZHRoLCB2aCwgdncpO1xuXG4gICAgaWYgKCFzaG91bGRFeGNlZWQpIHtcbiAgICAgIGNvbnN0IGxpbWl0ZWRTY2FsZTogbnVtYmVyID0gZ2V0U2NhbGUoXG4gICAgICAgIGltYWdlSGVpZ2h0LFxuICAgICAgICBpbWFnZVdpZHRoLFxuICAgICAgICBpbWFnZS5uYXR1cmFsSGVpZ2h0LFxuICAgICAgICBpbWFnZS5uYXR1cmFsV2lkdGhcbiAgICAgICk7XG4gICAgICBzY2FsZSA9IE1hdGgubWluKHNjYWxlLCBsaW1pdGVkU2NhbGUpO1xuICAgIH1cblxuICAgIGNvbnN0IGlzUGFkZGluZ05lZWRlZDogYm9vbGVhbiA9XG4gICAgICBjb25maWcucGFkZGluZyA+XG4gICAgICBNYXRoLm1pbih2aCAtIGltYWdlSGVpZ2h0ICogc2NhbGUsIHZ3IC0gaW1hZ2VXaWR0aCAqIHNjYWxlKSAvIDI7XG5cbiAgICBpZiAoaXNQYWRkaW5nTmVlZGVkKSB7XG4gICAgICBsZXQgc2NhbGVXaXRoUGFkZGluZ0JlZm9yZUV4Y2VlZDogbnVtYmVyID0gZ2V0U2NhbGUoXG4gICAgICAgIGltYWdlSGVpZ2h0ICsgY29uZmlnLnBhZGRpbmcsXG4gICAgICAgIGltYWdlV2lkdGggKyBjb25maWcucGFkZGluZyxcbiAgICAgICAgdmgsXG4gICAgICAgIHZ3XG4gICAgICApO1xuXG4gICAgICBpZiAoIXNob3VsZEV4Y2VlZCkge1xuICAgICAgICBjb25zdCBsaW1pdGVkU2NhbGU6IG51bWJlciA9IGdldFNjYWxlKFxuICAgICAgICAgIGltYWdlSGVpZ2h0LFxuICAgICAgICAgIGltYWdlV2lkdGgsXG4gICAgICAgICAgaW1hZ2UubmF0dXJhbEhlaWdodCAtIGNvbmZpZy5wYWRkaW5nLFxuICAgICAgICAgIGltYWdlLm5hdHVyYWxXaWR0aCAtIGNvbmZpZy5wYWRkaW5nXG4gICAgICAgICk7XG4gICAgICAgIHNjYWxlV2l0aFBhZGRpbmdCZWZvcmVFeGNlZWQgPSBNYXRoLm1pbihcbiAgICAgICAgICBzY2FsZVdpdGhQYWRkaW5nQmVmb3JlRXhjZWVkLFxuICAgICAgICAgIGxpbWl0ZWRTY2FsZVxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICBzY2FsZSA9IHNjYWxlV2l0aFBhZGRpbmdCZWZvcmVFeGNlZWQ7XG4gICAgfVxuXG4gICAgY29uc3QgZG9jOiBIVE1MRWxlbWVudCA9IHRoaXMuZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50O1xuICAgIGNvbnN0IHNjcm9sbExlZnQ6IG51bWJlciA9XG4gICAgICAodGhpcy53aW5kb3cucGFnZVhPZmZzZXQgfHwgZG9jLnNjcm9sbExlZnQpIC0gKGRvYy5jbGllbnRMZWZ0IHx8IDApO1xuICAgIGNvbnN0IHNjcm9sbFRvcDogbnVtYmVyID1cbiAgICAgICh0aGlzLndpbmRvdy5wYWdlWU9mZnNldCB8fCBkb2Muc2Nyb2xsVG9wKSAtIChkb2MuY2xpZW50VG9wIHx8IDApO1xuXG4gICAgY29uc3QgaW1hZ2VDZW50ZXJYOiBudW1iZXIgPVxuICAgICAgc2Nyb2xsTGVmdCArIGltYWdlUmVjdC5sZWZ0ICsgaW1hZ2VSZWN0LndpZHRoIC8gMjtcbiAgICBjb25zdCBpbWFnZUNlbnRlclk6IG51bWJlciA9XG4gICAgICBzY3JvbGxUb3AgKyBpbWFnZVJlY3QudG9wICsgaW1hZ2VSZWN0LmhlaWdodCAvIDI7XG5cbiAgICBjb25zdCBzY3JlZW5DZW50ZXJYOiBudW1iZXIgPSBzY3JvbGxMZWZ0ICsgdncgLyAyO1xuICAgIGNvbnN0IHNjcmVlbkNlbnRlclk6IG51bWJlciA9IHNjcm9sbFRvcCArIHZoIC8gMjtcblxuICAgIGNvbnN0IHRyYW5zbGF0ZVg6IG51bWJlciA9IChzY3JlZW5DZW50ZXJYIC0gaW1hZ2VDZW50ZXJYKSAvIHNjYWxlO1xuICAgIGNvbnN0IHRyYW5zbGF0ZVk6IG51bWJlciA9IChzY3JlZW5DZW50ZXJZIC0gaW1hZ2VDZW50ZXJZKSAvIHNjYWxlO1xuXG4gICAgaW1hZ2UuY2xhc3NMaXN0LmFkZCgnaW1hZ2Utem9vbS16b29tZWQnKTtcbiAgICBpbWFnZS5wYXJlbnRFbGVtZW50Py5jbGFzc0xpc3QuYWRkKCdpbWFnZS16b29tLXdyYXBwZXItem9vbWVkJyk7XG4gICAgaW1hZ2Uuc3R5bGUudHJhbnNmb3JtID0gYHNjYWxlKCR7c2NhbGV9KSB0cmFuc2xhdGUoJHt0cmFuc2xhdGVYfXB4LCAke3RyYW5zbGF0ZVl9cHgpYDtcbiAgfTtcblxuICBwcml2YXRlIHByb2Nlc3NJbWFnZSA9IChpbWFnZTogSFRNTEltYWdlRWxlbWVudCkgPT4ge1xuICAgIC8vIGNyZWF0ZSBhbiBpbWFnZSB3cmFwcGVyIGVsZW1lbnRcbiAgICBjb25zdCB3cmFwcGVyID0gdGhpcy5kb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcblxuICAgIC8vIGxldCB3cmFwcGVyIG1pbWljayBwZWFybCBkaXNwbGF5IHByb3BlcnR5IHRvIG5vdCBicmVhayBhbnl0aGluZ1xuICAgIHdyYXBwZXIuY2xhc3NMaXN0LmFkZCgnaW1hZ2Utem9vbS13cmFwcGVyJyk7XG4gICAgd3JhcHBlci5zdHlsZS5kaXNwbGF5ID0gdGhpcy53aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZShpbWFnZSkuZGlzcGxheTtcbiAgICBpbWFnZS5wYXJlbnRFbGVtZW50Py5pbnNlcnRCZWZvcmUod3JhcHBlciwgaW1hZ2UpO1xuICAgIHdyYXBwZXIuYXBwZW5kQ2hpbGQoaW1hZ2UpO1xuXG4gICAgaW1hZ2UuY2xhc3NMaXN0LmFkZCgnaW1hZ2Utem9vbScpO1xuICAgIGltYWdlLnN0eWxlLnRyYW5zZm9ybSA9ICdzY2FsZSgxKSc7XG4gIH07XG59XG4iXX0=